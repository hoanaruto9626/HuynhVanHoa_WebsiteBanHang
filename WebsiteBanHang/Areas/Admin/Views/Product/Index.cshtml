@using PagedList;
@using PagedList.Mvc;
@model PagedList.IPagedList<WebsiteBanHang.Connect.Product>

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<style>
    .pagination .page-item.active .page-link {
        background-color: #428bca; /* Màu nền giống hover */
        border-color: #428bca; /* Màu viền giống hover */
        color: #fff; /* Màu chữ */
    }

    .pagination .page-item.active .page-link:hover {
        background-color: #0056b3; /* Màu nền khi hover vào trang đã chọn */
        border-color: #0056b3;    /* Màu viền khi hover vào trang đã chọn */
    }
</style>

<div class="content-wrapper">
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-4">
                <div class="col-sm-6">
                    <h2 class="text-primary font-weight-bold">Danh sách sản phẩm</h2>
                </div>
                <div class="col-sm-6 text-right">
                    <a href="@Url.Action("Create")" class="btn btn-success btn-lg d-inline-flex align-items-center shadow">
                        <i class="fas fa-plus-circle mr-2"></i> Thêm sản phẩm
                    </a>
                </div>
            </div>
        </div>
    </section>

    <section class="content">
        <div class="container-fluid">
            @using (Html.BeginForm("Index", "Product", FormMethod.Get, new { @class = "form-inline", id = "searchForm" }))
            {
                <div class="row mb-4">
                    <div class="col-sm-12">
                        <div class="card">
                            <div class="card-body d-flex align-items-center">
                                <label for="SearchString" class="mr-2 font-weight-bold">Tìm kiếm:</label>
                                <input type="text" id="SearchString" class="form-control mx-2" value="@ViewBag.CurrentFilter" name="SearchString" placeholder="Nhập tên sản phẩm">
                                <button type="button" class="btn btn-danger" id="search-button">
                                    <i class="fas fa-search"></i> Tìm kiếm
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title">Danh sách sản phẩm</h3>
                </div>
                <div class="card-body">
                    <table class="table table-bordered table-striped text-center align-middle">
                        <thead class="thead-dark">
                            <tr>
                                <th>Ảnh</th>
                                <th>Tên sản phẩm</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="product-list">
                            @* Nơi hiển thị sản phẩm *@
                            @Html.Partial("_ProductListPartial", Model)
                        </tbody>
                    </table>
                </div>
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-6 col-lg-6 col-xs-6 col-sm-6">
                            <p style="display:inline-block">Kích thước trang:</p>
                            <span style="display: inline-block;">
                                @Html.DropDownList("size", (SelectList)ViewBag.Size, new { @class = "form-control short-dropdown", id = "size" })
                            </span>
                        </div>
                        <div class="col-md-6 text-right">
                            <span id="total-count">Tổng cộng: @Model.TotalItemCount sản phẩm</span>
                        </div>
                        <div class="col-md-6 col-lg-6 col-xs-6 col-sm-6 text-right">
                            Trang: @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) / @Model.PageCount
                        </div>
                    </div>
                    <div id="pagination" class="d-flex justify-content-center">
                        @Html.PagedListPager(Model, page => Url.Action("Index", new { searchString = ViewBag.CurrentFilter, size = ViewBag.CurrentSize, page = page }), PagedListRenderOptions.ClassicPlusFirstAndLast)
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<script>
    $(document).ready(function () {
        // Hàm tìm kiếm và phân trang
        function loadProducts(page, size, searchString) {
            $.ajax({
                url: '@Url.Action("Index", "Product")',
                type: 'GET',
                data: { SearchString: searchString, page: page, size: size },
                success: function (data) {
                    // Cập nhật danh sách sản phẩm
                    var productHtml = '';
                    $.each(data.Products, function (i, product) {
                        productHtml += '<tr>' +
                                        '<td><img src="/Content/images/product/' + product.Image + '" class="img-thumbnail" style="width: 80px; height: 80px;" alt="' + product.Name + '"></td>' +
                                        '<td>' + product.Name + '</td>' +
                                        '<td class="text-success">' + product.Price.toLocaleString() + ' ₫</td>' +
                                        '<td class="text-center">' + (product.Quantity || '') + '</td>' +
                                        '<td>' +
                                            '<div class="btn-group">' +
                                                '<a href="@Url.Action("Details", "Product", new { id = "PLACEHOLDER" })'.replace("PLACEHOLDER", product.Id) + '" class="btn btn-sm btn-primary"><i class="fas fa-eye"></i> Chi tiết</a>' +
                                                '<a href="@Url.Action("Edit", "Product", new { id = "PLACEHOLDER" })'.replace("PLACEHOLDER", product.Id) + '" class="btn btn-sm btn-info"><i class="fas fa-edit"></i> Sửa</a>' +
                                                '<a href="@Url.Action("Delete", "Product", new { id = "PLACEHOLDER" })'.replace("PLACEHOLDER", product.Id) + '" class="btn btn-sm btn-danger" onclick="return confirm(\'Bạn có chắc muốn xóa sản phẩm này?\');"><i class="fas fa-trash"></i> Xóa</a>' +
                                            '</div>' +
                                        '</td>' +
                                    '</tr>';
                    });
                    $("#product-list").html(productHtml);

                    // Cập nhật phân trang
                    updatePagination(data.CurrentPage, data.TotalPages, data.TotalItemCount, size, searchString);
                }
            });
        }

        // Cập nhật phân trang
        function updatePagination(currentPage, totalPages, totalItemCount, size, searchString) {
            var paginationHtml = '';
            if (totalPages > 1) {
                paginationHtml += '<ul class="pagination justify-content-center">';
                // Nút về trang đầu
                if (currentPage > 1) {
                    paginationHtml += '<li class="page-item"><a class="page-link" href="#" data-page="' + (currentPage - 1) + '" data-size="' + size + '" data-search="' + searchString + '">«</a></li>';
                }
                for (var i = 1; i <= totalPages; i++) {
                    if (i == currentPage) {
                        paginationHtml += '<li class="page-item active"><span class="page-link">' + i + '</span></li>';
                    } else {
                        paginationHtml += '<li class="page-item"><a class="page-link" href="#" data-page="' + i + '" data-size="' + size + '" data-search="' + searchString + '">' + i + '</a></li>';
                    }
                }
                if (currentPage < totalPages) {
                    paginationHtml += '<li class="page-item"><a class="page-link" href="#" data-page="' + (currentPage + 1) + '" data-size="' + size + '" data-search="' + searchString + '">»</a></li>';
                }
                paginationHtml += '</ul>';
            }
            $("#pagination").html(paginationHtml);
            $("#total-count").text("Tổng cộng: " + totalItemCount + " sản phẩm");
        }

        // Khi người dùng thay đổi trang
        $("#pagination").on("click", "a", function (e) {
            e.preventDefault();
            var page = $(this).data('page');
            var size = $(this).data('size');
            var searchString = $(this).data('search');
            loadProducts(page, size, searchString);
        });

        // Khi người dùng thay đổi số sản phẩm trên trang
        $("#size").change(function () {
            var size = $(this).val();
            var searchString = $("#SearchString").val();
            loadProducts(1, size, searchString);  // Tải lại từ trang 1 với số lượng mới
        });

        // Khi người dùng nhấn nút tìm kiếm
        $("#search-button").click(function () {
            var searchString = $("#SearchString").val();
            loadProducts(1, $("#size").val(), searchString);  // Tải lại từ trang 1 với từ khóa tìm kiếm mới
        });

        // Tải dữ liệu khi trang được tải lần đầu
        loadProducts(1, $("#size").val(), $("#SearchString").val());
    });
</script>